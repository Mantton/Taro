// Test: Optional Coercions
// Checks implicit coercions to Optional types (T->T?, nil->T?).

func main() {
    // ====== BASIC COERCIONS ======

    // Test 1: T -> T? coercion (wrap in some)
    var a: bool? = true
    match a {
        case .some(v) => { assert(v, "Bool coercion true") }
        case .none => { assert(false, "Bool coercion failed") }
    }

    // Test 2: nil -> T? coercion (wrap in none)
    var b: bool? = nil
    match b {
        case .none => assert(true, "Nil coercion ok")
        case .some(_) => assert(false, "Nil coercion fail")
    }

    // Test 3: Explicit Optional usage (should still work)
    var c: bool? = Optional.none
    var d: bool? = Optional.some(false)

    // Test 4: Integer coercion
    var e: int32? = 42
    var f: int32? = nil

    // ====== FUNCTION ARGUMENT COERCIONS ======

    // Test 5: Passing value to optional parameter
    acceptOptional(100)

    // Test 6: Passing nil to optional parameter
    acceptOptional(nil)

    // Test 7: Passing Optional value
    acceptOptional(Optional.some(200))

    // ====== STRUCT FIELD COERCIONS ======

    // Test 8: Struct literal with value coerced to optional
    var container1 = Container { value: 42 }

    // Test 9: Struct literal with nil
    var container2 = Container { value: nil }

    // Test 10: Struct literal with explicit Optional
    var container3 = Container { value: Optional.some(99) }

    // ====== EXISTENTIAL + OPTIONAL COERCIONS ======

    var myVal = MyValue { value: 10 }

    // Test 11: Concrete type -> existential -> optional
    acceptOptionalPrintable(myVal)

    // Test 12: nil -> (any Printable)?
    acceptOptionalPrintable(nil)

    // Test 13: Variable with optional existential
    var optPrint: (any Printable)? = myVal

    // Test 14: nil to optional existential variable
    var optPrint2: (any Printable)? = nil
    
    std.print("PASS: Optional coercions verified\n")
}

// Test struct with optional field
struct Container {
    value: int32?
}

// Test function accepting optional parameter
func acceptOptional(_ x: int32?) {
}

// Interface for existential boxing test
interface Printable {
    func print(&self)
}

struct MyValue: Copyable {
    value: int32
}


extend MyValue: Printable {
    func print(&self) {}
}

// Function accepting optional existential
func acceptOptionalPrintable(_ x: (any Printable)?) {}

// Function accepting optional interface directly
func acceptOptionalInterface(_ x: (any Printable)?) {}
